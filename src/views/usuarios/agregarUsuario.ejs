<section>
<div class="container mx-auto">
  <div class="text-center mb-6">
    <h1 class="text-3xl font-extrabold">Agregar Usuario - Completar los Campos</h1>
  </div>

  <div class="max-w-xl mx-auto bg-white p-6 rounded shadow">

    <form>

      <!-- Correo -->
      <div class="mb-4">
        <label class="block font-bold mb-2">Correo</label>
        <input type="email" id="correo" class="w-full border rounded p-2" placeholder="Ej. ejemplo@gmail.com">
        <span id="error-correo" class="text-red-500 text-sm error"></span>
      </div>

      <!-- Contraseña -->
      <div class="mb-4">
        <label class="block font-bold mb-2">Contraseña</label>
        <input type="password" id="contrasenia" class="w-full border rounded p-2" placeholder="Mínimo 6 caracteres">
        <span id="error-contrasenia" class="text-red-500 text-sm error"></span>
      </div>

      <!-- Nombre -->
      <div class="mb-4">
        <label class="block font-bold mb-2">Nombre</label>
        <input type="text" id="name" class="w-full border rounded p-2" placeholder="Ej. Enzo">
        <span id="error-name" class="text-red-500 text-sm error"></span>
      </div>

      <!-- Apellido -->
      <div class="mb-4">
        <label class="block font-bold mb-2">Apellido</label>
        <input type="text" id="apellido" class="w-full border rounded p-2" placeholder="Ej. Ramos">
        <span id="error-apellido" class="text-red-500 text-sm error"></span>
      </div>

      <!-- Avatar -->
      <div class="mb-4">
        <label class="block font-bold mb-2">Avatar (URL opcional)</label>
        <input type="text" id="avatar" class="w-full border rounded p-2" placeholder="URL del avatar">
        <span id="error-avatar" class="text-red-500 text-sm error"></span>
      </div>

      <!-- Estado -->
      <div class="mb-4">
        <label class="block font-bold mb-2">Estado</label>
        <select id="estado" class="w-full border rounded p-2">
          <option value="1">Activo</option>
          <option value="0">Inactivo</option>
        </select>
        <span id="error-estado" class="text-red-500 text-sm error"></span>
      </div>

      <!-- Rol -->
      <div class="mb-4">
        <label class="block font-bold mb-2">Rol</label>
        <select id="role">
  <% roles.forEach(r => { %>
    <option value="<%= r._id %>"><%= r.name %></option>
  <% }) %>
</select>

        <span id="error-role" class="text-red-500 text-sm error"></span>
      </div>

      <!-- Mensaje de éxito -->
      <div id="success-message" class="hidden p-4 mb-4 text-white rounded bg-green-600">
        Usuario agregado correctamente.
      </div>

      <!-- Botones -->
      <div class="flex items-center justify-center gap-8">
        <button type="button" onclick="GuardarUsuario()" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">Agregar</button>
        <button type="button" onclick="window.location = '/../usuarios'" class="bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded">Cancelar</button>
      </div>

    </form>
    <br>
  </div>
</div>

<script>
function GuardarUsuario() {

  document.querySelectorAll(".error").forEach(el => el.textContent = "");

  const correo = document.getElementById('correo').value.trim();
  const contrasenia = document.getElementById('contrasenia').value.trim();
  const name = document.getElementById('name').value.trim();
  const apellido = document.getElementById('apellido').value.trim();
  const avatar = document.getElementById('avatar').value.trim();
  const estado = document.getElementById('estado').value.trim();
  const role = document.getElementById('role').value.trim();

  let errores = [];

  if (!correo || correo.length < 5)
    errores.push({ field: 'correo', message: 'El correo es obligatorio.' });

  if (!contrasenia || contrasenia.length < 6)
    errores.push({ field: 'contrasenia', message: 'La contraseña debe tener al menos 6 caracteres.' });

  if (!name)
    errores.push({ field: 'name', message: 'El nombre es obligatorio.' });

  if (!apellido)
    errores.push({ field: 'apellido', message: 'El apellido es obligatorio.' });

  if (!role)
    errores.push({ field: 'role', message: 'Debe seleccionar un rol.' });

  if (errores.length > 0) {
    errores.forEach(error => {
      const span = document.getElementById(`error-${error.field}`);
      if (span) span.textContent = error.message;
    });
    alert('Por favor, corregí los errores antes de guardar.');
    return;
  }

  if (!confirm("¿Estás seguro que quieres agregar este usuario?")) return;

  const body = {
    correo,
    contrasenia,
    name,
    apellido,
    avatar,
    estado,
    role
  };

  fetch('/agregarUsuario', {
    method: 'POST',
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(body)
  })
  .then(async res => {
    const data = await res.json();

    if (res.ok && data.result === 'success') {

      const successMessage = document.getElementById('success-message');
      successMessage.classList.remove('hidden');

      setTimeout(() => {
        window.location.href = '/';
      }, 2000);

    } else {

      // Mostrar error único como con películas
      if (data.mensaje && data.mensaje.toLowerCase().includes("correo")) {
        document.getElementById("error-correo").textContent = data.mensaje;
      } else {
        alert(data.mensaje || "Error al guardar el usuario.");
      }
    }
  })
  .catch(err => {
    console.error(err);
    alert("Ocurrió un error inesperado.");
  });

}
</script>

</section>
