<section>
  <div class="container mx-auto mt-8">
    <h1 class="text-3xl font-extrabold text-center mb-6">Modificar Usuario</h1>

    <div class="max-w-xl mx-auto bg-white p-6 rounded shadow">
      <form>

        <!-- Correo -->
        <div class="mb-4">
          <label class="block font-bold mb-2">Correo</label>
          <input type="email" id="correo" value="<%= usuario.correo %>" class="w-full border rounded p-2">
          <span id="error-correo" class="text-red-500 text-sm error"></span>
        </div>

        <!-- Contraseña -->
        <div class="mb-4">
          <label class="block font-bold mb-2">Contraseña (dejar en blanco para no cambiar)</label>
          <input type="password" id="contrasenia" class="w-full border rounded p-2" placeholder="Nueva contraseña (opcional)">
          <span id="error-contrasenia" class="text-red-500 text-sm error"></span>
        </div>

        <!-- Nombre -->
        <div class="mb-4">
          <label class="block font-bold mb-2">Nombre</label>
          <input type="text" id="name" value="<%= usuario.name %>" class="w-full border rounded p-2">
          <span id="error-name" class="text-red-500 text-sm error"></span>
        </div>

        <!-- Apellido -->
        <div class="mb-4">
          <label class="block font-bold mb-2">Apellido</label>
          <input type="text" id="apellido" value="<%= usuario.apellido %>" class="w-full border rounded p-2">
          <span id="error-apellido" class="text-red-500 text-sm error"></span>
        </div>

        <!-- Avatar -->
        <div class="mb-4">
          <label class="block font-bold mb-2">Avatar (URL)</label>
          <input type="text" id="avatar" value="<%= usuario.avatar %>" class="w-full border rounded p-2" placeholder="URL del avatar">
          <span id="error-avatar" class="text-red-500 text-sm error"></span>
        </div>

        <!-- Estado -->
        <div class="mb-4">
          <label class="block font-bold mb-2">Estado</label>
          <select id="estado" class="w-full border rounded p-2">
            <option value="1" <%= usuario.estado === 1 ? 'selected' : '' %>>Activo</option>
            <option value="0" <%= usuario.estado === 0 ? 'selected' : '' %>>Inactivo</option>
          </select>
          <span id="error-estado" class="text-red-500 text-sm error"></span>
        </div>

        <!-- Role -->
        <div class="mb-4">
          <label class="block font-bold mb-2">Rol</label>
          <select id="role" class="w-full border rounded p-2">
            <% roles.forEach(r => { %>
              <option value="<%= r._id %>" <%= usuario.role && usuario.role._id && usuario.role._id.toString() === r._id.toString() ? 'selected' : '' %>>
                <%= r.name %>
              </option>
            <% }) %>
          </select>
          <span id="error-role" class="text-red-500 text-sm error"></span>
        </div>

        <div id="success-message" class="hidden p-4 mb-4 bg-green-600 text-white rounded">
          Usuario modificado correctamente.
        </div>

        <!-- Botones -->
        <div class="flex items-center justify-center gap-8 mt-4">
          <button type="button"
            onclick="ModificarUsuario('<%= usuario._id %>')"
            class="bg-blue-600 hover:bg-blue-800 text-white py-2 px-4 rounded font-bold">
            Modificar
          </button>

          <button type="button"
            onclick="window.location='/mostrarUsuarios'"
            class="bg-gray-500 hover:bg-gray-700 text-white py-2 px-4 rounded font-bold">
            Cancelar
          </button>
        </div>

      </form>
    </div>
  </div>

<script>
  function ModificarUsuario(id) {

    document.querySelectorAll(".error").forEach(e => e.textContent = "");

    const correo = document.getElementById('correo').value.trim();
    const contrasenia = document.getElementById('contrasenia').value.trim();
    const name = document.getElementById('name').value.trim();
    const apellido = document.getElementById('apellido').value.trim();
    const avatar = document.getElementById('avatar').value.trim();
    const estado = document.getElementById('estado').value;
    const role = document.getElementById('role').value;

    let errores = [];

    if (!correo || !correo.includes("@"))
      errores.push({ field: "correo", message: "Correo inválido." });

    // Contraseña es opcional en modificación
    if (contrasenia && contrasenia.length < 6)
      errores.push({ field: "contrasenia", message: "La contraseña debe tener mínimo 6 caracteres." });

    if (!name || name.length < 2)
      errores.push({ field: "name", message: "El nombre es obligatorio." });

    if (!apellido || apellido.length < 2)
      errores.push({ field: "apellido", message: "El apellido es obligatorio." });

    if (avatar && !avatar.startsWith("http"))
      errores.push({ field: "avatar", message: "El avatar debe ser una URL válida." });

    if (!role)
      errores.push({ field: "role", message: "Debe seleccionar un rol." });

    if (errores.length > 0) {
      errores.forEach(err => {
        document.getElementById(`error-${err.field}`).textContent = err.message;
      });
      alert("Corregí los errores antes de continuar.");
      return;
    }

    const body = {
      correo,
      name,
      apellido,
      avatar,
      estado,
      role
    };

    // Solo enviar contraseña si se ingresó una nueva
    if (contrasenia) {
      body.contrasenia = contrasenia;
    }

    fetch("/modificarUsuario/" + id, {
      method: "PUT",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(body)
    })
      .then(r => r.json())
      .then(data => {
        if (data.result === "success") {
          const msg = document.getElementById("success-message");
          msg.classList.remove("hidden");

          setTimeout(() => window.location = "/mostrarUsuarios", 2000);

        } else {
          alert(data.mensaje || "Error al modificar el usuario.");
        }
      })
      .catch(err => {
        console.error(err);
        alert("Error inesperado.");
      });
  }
</script>

</section>